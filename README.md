# Chain33知识库

## 文档目录
	- [文档修改记录](#文档修改记录)
	- [文档阅读说明](#文档阅读说明)
	- [术语介绍](#术语介绍)
	- [背景介绍](#背景介绍)
	- [主链和平行链架构说明](#主链和平行链架构说明)
	- [区块链功能模块介绍](#区块链功能模块介绍)
	- [区块链合约开发](#区块链合约开发)
	- [EVM合约概述](#EVM合约概述)
	- [合约部署调用](#合约部署调用)
	- [应用和chain33平行链对接注意事项](#应用和chain33平行链对接注意事项)

### 文档修改记
| 版本号 | 版本描述                              | 修改日期   | 备注 |
| ------ | ------------------------------------- | ---------- | ---- |
| V1.0   | 文档新建| 2022/07/21 |


### 文档阅读说明
- 术语介绍：简单了解  
- 背景介绍: 简单了解  
- 主链和平行链架构说明：想研究区块链底层技术可深入了解，如果只是要基于区块链做应用开发可简单了解
- 区块链功能模块介绍：对区块链底层有兴趣的可以深入了解  
- 区块链合约开发： 其中的[EVM合约概述]可结合链接中文档了解概念; [合约部署调用]：***重点了解***
- 应用和平行链对接注意事项: ***重点了解，是项目中踩过的坑，了解过后可少走弯路。***

### 术语介绍 
| 序号 | 术语 缩写                              | 解释   |
| ------- | -------------------------------------- | --------------------- |
| 1   | Chain33主链| Chain33主链采用POS33共识机制，共识效率高，且节点可随意加入和退出集群|
| 2   | 平行链| 平行链依附于主链，平行链之间通过名称来区分，平行链与平行链之间数据相互隔离， 平行链与主链之间通过grpc通信。|
| 3   | EVM| 以太坊虚拟机的缩写，目前EVM算是区块链中最大的生态，很多链都支持EVM的能力，森田平行链也完全兼容EVM,通过EVM可以动态的部署智能合约进行计算|
| 4   | ERC721| 运行在EVM中，服务于非同质化代币（NFT）, 每个Token都是不一样的，都有自己的唯一性和独特价值,不可分割，可追踪。|
| 5   | ERC1155| 运行在EVM中，也是服务于非同质化代币(NFT),相比于ERC721它同时还支持在一个合约中存储多个数字资产，支持一次性批量发行多个不同类型的的数字资产，支持在一次转账过程中转多个不同类型的数字资产。|
| 6   | 交易组| 把两笔及以上的交易放在一个组里一次性发送。|
| 7   | 代扣手续费| 将代扣交易和正常用户的交易打包进一个交易组中，代扣交易使用代扣地址签名，用于主链上手续费扣除。（适用于能过java-sdk和go-sdk对接的方式，不适用于web3.js对接方式）|
| 8   | SDK| 封装了同区块链交互的接口和区块链通用方法（包括：公私钥生成，签名，交易构造等）, 支持java-sdk, go-sdk, web3.js等 |

### 背景介绍
Chain33主链和平行链都是基于Chain33区块链开发框架开发出来的，主链和平行链的的区别就是加载了不同的共识机制插件。      
- POS33共识插件：Chain33主链共识插件，采用抽签投票方式pos共识算法. 
- PARA共识插件：平行链共识插件，平行链不是独立存在的，它依附于主链（上述的5种都是主链），利用主链的共识算法来保证其安全性，同时平行链实现交易执行分片，主链下可以挂很多不同名称的平行链，每条平行链只负责自己独立的业务。 平行链条数的增加不会影响主链的性能，也不会影响其它平行链的性能。 比如EVM合约运行在平行链上， 而主链上只对这些交易的原始信息做共识和存证，所以主链只做存证而不用做具体的计算性能就可以很高。   

### 主链和平行链架构说明
主链采用抽签投票POS共识机制, 抽签的目的是减少投票人的数量. 每轮进行两次抽签, 第一次抽出候选的出块人, 第二次抽出投票人. 然后由投票人对候选的区块制作人投票, 谁的票多谁就制作新区块. 主链采用vrf 算法抽签, 根据自己的密钥以及区块高度和其他公共信息, 计算一个随机数, 如果此随机数小于某个给定的数值, 表示抽取成功. 为了减少出块时间, 系统提前进行抽签和投票, 这样出块人可以提前准备好出块的数据. 无需在本轮等待抽签和投票数据. 通过以上机制主链拥有较高的TPS。 

![主链交易流程](./resources/%E4%B8%BB%E9%93%BE%E4%BA%A4%E6%98%93%E6%B5%81%E7%A8%8B.png)

**主链内部交易流程：**
1. 客户端将交易签名后，通过RPC模块送发到总部节点的交易缓存池模块缓存（交易来源有两种途径：1.直连主链的应用;2.主链下的平行链节点）。  
2. 节点的缓存池检查交易的合法性：是否重复，签名是否正确，是否过期等  
3. 节点将交易通过P2P模块向其它节点广播交易，保证所有节点交易缓存池中的交易一致  
4. 当前轮次出块节点的共识模块，从交易缓存池中拉取交易列表，构造区块  
5. 共识模块将对该区块的共识消息广播给网络中的其它节点做共识处理  
6. 共识模块发送区块给执行器（原生智能合约，EVM虚拟机）模块来执行交易  
7. 执行完成后，共识模块将区块发送给账本模块做处理  
8. 调用底层存储，将账本存储在节点数据库中  
9. 账本再通过P2P模块将区块广播给其它节点，接收到区块的节点再次验证并执行区块中的交易并存储区块  

![主链平行链拓扑图](./resources/%E4%B8%BB%E9%93%BE%E5%B9%B3%E8%A1%8C%E9%93%BE%E6%8B%93%E6%89%91%E5%9B%BE.png)


**主链+平行链交易流程：**
1. 交易在链下完成构造和签名,交易构造时需要在交易体中带上对应平行链的名称, 签好名的交易通过平行链的jsonrpc接口发往平行链节点。   
2. 平行链通过它和主链之间的grpc连接,将交易转发到主链节点,由主链打包区块共识后存入主链账本。
3. 平行链节点给应用层实时返回一串交易hash，由它来标识这笔交易上链的唯一性（注意此时交易并没有成功写入账本，还需要后续处理）
4. 主链对新产生的区块进行共识，并写入主账本
5. 主链区块生成后,平行链实时拉取新产生的区块,过滤出属于本平行链的交易（根据平行链名称）, 送入虚拟机执行后并写入平行链账本。  

*备注： 支持在同一台服务器上同时部署BTY主链节点和BTY平行链节点（只要保证两者的jsonrpc和grpc端口不冲突即可）*
	
### 区块链功能模块介绍
![功能架构图](./resources/%E5%8A%9F%E8%83%BD%E6%9E%B6%E6%9E%84%E5%9B%BE.png)

 Chain33是一套区块链的底层开发框架， 它是在2018年11月11日在github上开源。 Chain33由模块化架构支撑，并具备极佳的可伸缩性，灵活性和可扩展性。 Chain33被设计成支持多模块（9个模块，如左图）插拔启用，能适应在行业生态中的各种应用场景，可以按需求构建公有链生态，联盟链生态，私有链生态。  

在架构设计之初，我们设计了一个基于消息传递的架构，所有的模块都是通过一个消息队列通信，而不是直接互相调用（如左图）。 这样不管是我们内部的研发，还是第三方的开发者，只要实现了一个模块的消息协议就可以用他自己的逻辑替换掉这个模块，对二次开发非常有用。  

[[Chain33区块链框架开源地址]](https://github.com/33cn/chain33)  
[[Chain33区块链插件库开源地址]](https://github.com/33cn/plugin)  
[[Chain33功能模块设计说明]](https://chain.33.cn/document/72)  

### 区块链合约开发
目前以太坊的EVM是区块链中最大的生态，大部分知名的公链都已经兼容EVM或准备兼容EVM(像BSC, AVAX, 波卡, Solana等)。 所以对区块链应用开发者来说，学会编写调试solidity合约，且能把合约部署到链上的EVM虚拟机中并进行调用，是入门区块链应用开发的必经途径。  
Chain33也已经全面兼容以太坊的EVM，同时还兼容以太坊的接口，以太坊地址格式，以太坊的签名方式。所以Chain33可以无缝的使用几乎所有的以太坊生态工具，包括remix在线IDE，小狐狸插件， web3.js库，truffle，hardhat工具等等，极大的方便了开发者。

#### Chain33测试环境说明
为了方便开发者快速验证，准备了测试环境(在合约部署调用时用到)   
1. web3.js接口  
平行链web3接口，此接口适用于通过web3.js库接入区块链的场景  
	- RPC URL:  http://122.224.77.188:8546
	- ChainId:  39991  
	- 货币符号：para  

2. jsonrpc接口  
接口适用于通过java-sdk，go-sdk接入区块链的场景
	- json rpc: http://122.224.77.188:8991  

3. 燃料获取  
在github的[issue](https://github.com/web3chain33/chain33-respo/issues)标签下[New issue], 格式如下：
Title: 测试燃料申请  
内容：   
	- 对接方式： 填写是使用web3.js, java-sdk还是go-sdk来对接
	- 用户地址： 写上自己的地址（地址生成方式可通过metamask插件，java-sdk或go-sdk，具体使用方式可参考下文）
	- 用途： 发行NFT，还是存证，或是发行ERC20等

#### EVM合约概述
合约运行在平行链的EVM虚拟机中, EVM虚拟机运行solidity语言编写和编译的智能合约。   
Solidity语言更多信息, 请参阅  [[Solidity中文官方文档]](https://learnblockchain.cn/docs/solidity/)  
下文[NFT合约说明]链接介绍基于EVM的ERC1155和ERC721两类非同质化通证合约最简单的使用。  
合约的基本介绍 [[NFT合约说明]](./NFT合约说明.md)   

### 合约部署调用     
根据应用层开发语言的不同，用户可选用web3.js， java-sdk, go-sdk等方式接入区块链   
#### web3.js 
chain33平行链除了兼容以太坊虚拟机（EVM）,同时在接口上也做了适配， 完全兼容web3.js，小狐狸插件（metamask），truffle, remix等以太坊生态工具。  以下连接介绍结合remix, metamask，truffle等工具部署运行智能合约。  
 web3.js部署调用合约参考链接： [[web3-sdk]](./web3-sdk/web3-sdk.md) :  介绍开启主链手续费情况下, 在平行链上部署调用智能合约。  

#### JAVA-SDK
适用于应用平台使用JAVA开发的情况,提供SDK对应的jar包，SDK里包含了公私钥生成,合约部署方法,合约调用方法,交易签名,交易查询,区块链信息查询等方法。   
JAVA-SDK开发环境部署参考链接： [[JAVA-SDK]](./java-sdk/java-sdk.md)  

#### GO-SDK  
适用于应用平台使用GO语言开发的情况,提供SDK对应的jar包，SDK里包含了公私钥生成,合约部署方法,合约调用方法,交易签名,交易查询,区块链信息查询等方法。 
GO-SDK开发环境部署参考链接： [[JAVA-SDK]](./go-sdk/go-sdk.md)  

### 应用和chain33平行链对接注意事项   
由于主链涉及燃料费,同时主链平均每1-3秒一个确认的特性,可能会存在交易的失败,主要有以下两大类情况：  
1. 交易上链了，但交易执行失败（有返回交易hash）：   这类交易通过了mempool（交易缓存池）的合法性检查，但是在合约执行过程中失败了（ 比如转移了错误数量的NFT）。
2. 交易没有上链（没有返回交易hash，rpc接口直接返回出错信息）： 这类交易在mempool的合法性检查中没有通过，包括以下以类错误：  
	- 签名错误（ErrSign）： 签名校验不通过，一般不会遇到，除非人为去改交易内容。  -- 不常见   
	- 交易重复（ErrDupTx）：mempool中发现重复交易，一般不会遇到，除非人为发送重复交易（所谓重复是hash完全一模一样的两笔交易，而不是指业务上数据相同）。 -- 不常见   
	- 手续费不足： 代扣地址下手续费不足会导致交易无法上链，需要保证代扣地址下GAS费充足。  -- 有可能会遇到  
	- 手续费太低（ErrTxFeeTooLow）： 交易设置的手续费比链上要求的手续费低，常见于部署EVM合约或批量发行大量NFT的场合， 需要通过queryEVMGas预估计出一个GAS费，然后在这个基础上再加上0.001作为手续费，这样能保证交易不会上链失败。 -- 有可能遇到，参考用例中手续费设置方式 
	- 交易账户在mempool中存在过多交易（ErrManyTx）： YCC为防止来自于同一个地址的频繁交易，限制每个账户在mempool中的最大交易数量不能超过100， 所以当交易频率很高时，mempool中代扣手续费的交易（都是来自同一个代扣地址）可能会超过100的， 而100笔以后的交易会被丢弃（rpc返回errmanytx的错）从而导致关联的交易也被丢弃。   -- 有可能会遇到   

举例说明应用层和区块链整合后的一般处理方案：  
为保证数据的一致性，需要判断交易在区块链上确实成功（拿到交易hash，且实际交易的执行结果是：ExecOk）, 业务上才能判定为成功。    且BTY支持以代扣的方式来扣除用户交易的燃料费， 代扣包含两笔交易：第一笔是代扣的交易（最简单的存证）， 第二笔是实际用户的交易。  交易上链后，区块链返回的是第一笔交易的hash值， 而这笔交易hash不能用于判断交易是否执行成功，需要拿这个hash值查到对应的第二笔交易才能判断。  具体见下面处理流程以及测试用例：  

场景：NFT平台上新品，大量用户抢购。  
处理流程：  
1. 用户完成支付，应用层触发NFT转账动作，并拿到区块链返回的交易hash(在采用代扣的情况下，这个hash对应的是代扣手续费交易，而非实际转NFT交易)  
2. 由于区块链是异步处理且有一定时延，这时NFT资产还没有真正转到用户地址下，但应用层可以预先将该笔订单标记为【待完成】。 这个状态不用给用户显示，只由应用层记录，对于用户而言，他只要一完成支付，就视为成功，不需要让他等待区块链的处理结果。  
3. 应用层把第1步中拿到的hash放到处理队列中，定时拿这个hash去查结果，如果查询结果返回空，hash继续留在队列中等待下一次查询， 如果结果不为空，从返回结果中拿到第二笔交易的hash,再根据这第二笔的交易hash去查询（这一步查询不用等待，拿到hash后可以马上查），从这次查询的返回结果拿到执行结果，如果是ExecOk代表执行成功，应用层再【待完成】的订单标记为【完成】，并从处理队列中删除第一笔交易的hash。 如果结果是ExecPack，代表执行失败，这个一般可能是业务上的bug(比如转了超过地址下数量的NFT资产，或是权限不够等等)，这种情况后续怎么处理由应用层根据实际情况来判断。    
4. 其它异常  
4.1 根据hash一直查不到有结果返回的可能性况： 1. 部署的平行链名称和上链交易中带的平行链名称不一致。  2.  平行链连接的主链节点高度落后于主网最大高度，或是平行连连接的那个主链节点离线。  
4.2 数据上链后，没有拿到交易hash，且rpc返回ErrTxFeeTooLow， 代表设置的交易手续费低于区块链所需的最低手续费。 需要在发交易前调用查询GAS费接口来估算出手续费（参考用例），再设置到交易中。  
4.3 数据上链后，没有拿到交易hash，且rpc返回ErrManyTx。  有大量交易上来时，应用层用队列缓存发送，比如每间隔10秒发送100笔交易，这样基本能解决ErrManyTx问题，如果再有个别交易还发生ErrManyTx，也需要把失败的再放回队列，后面重新发送。  
4.4 数据上链后，没有拿到交易hash，且rpc返回ErrTxMsgSizeTooBig， 代表交易体太大。 一般出现于ERC1155批量mint一批NFT时， 建议一次mint的token数量不要超过1000个， 数量比较大的，可以分多次来mint。  
4.5 定期检查代扣地址下的余额，保证手续费充足。  

